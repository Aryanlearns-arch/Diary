<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Private Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;background:#0b0d14;color:white}
.screen{max-width:520px;margin:auto;padding:40px 20px;min-height:100vh}
.hidden{display:none}

h1{font-size:30px;font-weight:700;margin-bottom:8px}
p{color:#a0a5b5;margin-bottom:24px}

input{width:100%;padding:14px;border-radius:14px;border:none;background:rgba(255,255,255,0.04);color:white;font-size:16px}

button{width:100%;padding:14px;border-radius:999px;border:none;background:linear-gradient(135deg,#8ba4ff,#6f85ff);color:white;font-weight:600;font-size:15px;margin-top:14px}

#app header{display:flex;justify-content:space-between;align-items:center}

.logout{font-size:13px;color:#a0a5b5;cursor:pointer}
.logout:hover{color:white}

.editor{background:rgba(255,255,255,0.04);border-radius:20px;padding:16px;margin-top:20px;border:1px solid rgba(255,255,255,0.08)}

textarea{width:100%;background:transparent;border:none;resize:none;outline:none;color:white;font-size:16px;min-height:120px}

.toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.toolbar span{font-size:13px;color:#a0a5b5}

.feed{margin-top:26px}

.entry{background:rgba(255,255,255,0.03);border-radius:18px;padding:14px 16px;margin-top:12px;border:1px solid rgba(255,255,255,0.07)}
.entry time{display:block;margin-top:6px;font-size:12px;color:#a0a5b5}
</style>
</head>

<body>

<div id="login" class="screen">
  <h1>Welcome</h1>
  <p>Your private space. Only you can see what you write.</p>
  <input id="email" type="email" placeholder="Email address">
  <button onclick="sendLink()">Send magic link</button>
</div>

<div id="app" class="screen hidden">
  <header>
    <h1>My Diary</h1>
    <div class="logout" onclick="logout()">Log out</div>
  </header>

  <div class="editor">
    <textarea id="entry" placeholder="Write something..."></textarea>
    <div class="toolbar">
      <span>Your thoughts stay private</span>
      <button onclick="addEntry()">Save</button>
    </div>
  </div>

  <div id="feed" class="feed"></div>
</div>

<script>
const SUPABASE_URL="https://fzgmpdybtnjzqikxfaco.supabase.co";
const SUPABASE_KEY="sb_publishable_-uOtGJkoTs43mx32klszYQ_pOAdTkEJ";
const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const login=document.getElementById("login");
const app=document.getElementById("app");

client.auth.getSession().then(({data})=>{
  if(data.session) showApp();
});

client.auth.onAuthStateChange((_,session)=>{
  if(session) showApp();
  else showLogin();
});

function showApp(){
  login.classList.add("hidden");
  app.classList.remove("hidden");
  loadEntries();
}

function showLogin(){
  app.classList.add("hidden");
  login.classList.remove("hidden");
}

async function sendLink(){
  const email=document.getElementById("email").value.trim();
  if(!email) return alert("Enter your email");
  await client.auth.signInWithOtp({email});
  alert("Check your email for the login link.");
}

async function loadEntries(){
  const {data}=await client.from("diary").select("content,created_at").order("created_at",{ascending:false});
  document.getElementById("feed").innerHTML=data.map(d=>{
    const t=new Date(d.created_at);
    const f=t.toLocaleString(undefined,{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"short",year:"numeric"});
    return `<div class="entry"><div>${d.content}</div><time>${f}</time></div>`;
  }).join("");
}

async function addEntry(){
  const text=document.getElementById("entry").value.trim();
  if(!text) return;
  const {data:userData}=await client.auth.getUser();
  await client.from("diary").insert({content:text,user_id:userData.user.id});
  document.getElementById("entry").value="";
  loadEntries();
}

async function logout(){
  await client.auth.signOut();
}
</script>

</body>
</html>