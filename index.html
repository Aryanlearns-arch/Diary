<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Private Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div id="login">
  <input id="email" placeholder="Email">
  <button onclick="sendLink()">Send link</button>
</div>

<div id="app" style="display:none">
  <textarea id="entry"></textarea>
  <button onclick="addEntry()">Save</button>
  <div id="feed"></div>
</div>

<script>
const SUPABASE_URL = "https://fzgmpdybtnjzqikxfaco.supabase.co";
const SUPABASE_KEY = "sb_publishable_-uOtGJkoTs43mx32klszYQ_pOAdTkEJ";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const login = document.getElementById("login");
const app = document.getElementById("app");

client.auth.getSession().then(({data})=>{
  if(data.session) showApp();
});

client.auth.onAuthStateChange((_,session)=>{
  if(session) showApp();
});

function showApp(){
  login.style.display="none";
  app.style.display="block";
  loadEntries();
}

async function sendLink(){
  const email=document.getElementById("email").value.trim();
  await client.auth.signInWithOtp({ email });
}

async function loadEntries(){
  const {data}=await client.from("diary").select("*");
  document.getElementById("feed").innerHTML = data.map(d=>`<div>${d.content}</div>`).join("");
}

async function addEntry(){
  const text=document.getElementById("entry").value.trim();
  const {data:userData}=await client.auth.getUser();
  await client.from("diary").insert({content:text,user_id:userData.user.id});
  loadEntries();
}
</script>

</body>
</html>