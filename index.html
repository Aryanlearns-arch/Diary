<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Private Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0d14;color:white}
.screen{max-width:460px;margin:auto;padding:28px;min-height:100vh}
#app{display:none}
input,textarea,button{width:100%;padding:14px;margin-top:12px;border-radius:12px;border:none}
button{background:#6f85ff;color:white;font-weight:600}
.post{background:#111;border-radius:12px;padding:12px;margin-top:10px}
</style>
</head>

<body>

<div id="login" class="screen">
  <h1>Login</h1>
  <input id="email" type="email" placeholder="Email">
  <button onclick="sendLink()">Send magic link</button>
</div>

<div id="app" class="screen">
  <h1>My Diary</h1>
  <textarea id="entry"></textarea>
  <button onclick="addEntry()">Save</button>
  <div id="feed"></div>
  <button onclick="logout()">Logout</button>
</div>

<script>
function log(e){ console.error(e); alert("Error: " + e.message); }

window.onload = async () => {
  if (!window.supabase) {
    alert("Supabase failed to load. Check internet or script tag.");
    return;
  }

  const client = supabase.createClient(
    "https://fzgmpdybtnjzqikxfaco.supabase.co",
    "sb_publishable_-uOtGJkoTs43mx32klszYQ_pOAdTkEJ"
  );

  window.client = client;

  const login = document.getElementById("login");
  const app = document.getElementById("app");

  async function showApp() {
    login.style.display = "none";
    app.style.display = "block";
    loadEntries();
  }

  async function loadEntries() {
    const { data, error } = await client.from("diary").select("*").order("created_at",{ascending:false});
    if(error) return log(error);

    document.getElementById("feed").innerHTML = data.map(d=>`
      <div class="post">${d.content}</div>
    `).join("");
  }

  window.sendLink = async () => {
    const email = document.getElementById("email").value.trim();
    if(!email) return alert("Enter email");

    const { error } = await client.auth.signInWithOtp({
      email,
      options:{ emailRedirectTo:"https://diary-w3k8.onrender.com" }
    });

    if(error) log(error);
    else alert("Check your email.");
  };

  window.addEntry = async () => {
    const text = document.getElementById("entry").value.trim();
    if(!text) return;

    const { data:userData, error:userError } = await client.auth.getUser();
    if(userError || !userData?.user) return alert("Not logged in");

    const { error } = await client.from("diary").insert({
      content:text,
      user_id:userData.user.id
    });

    if(error) return log(error);

    document.getElementById("entry").value="";
    loadEntries();
  };

  window.logout = async () => {
    await client.auth.signOut();
    app.style.display="none";
    login.style.display="block";
  };

  client.auth.onAuthStateChange((_,session)=>{
    if(session) showApp();
  });

  const { data } = await client.auth.getSession();
  if(data.session) showApp();
};
</script>

</body>
</html>