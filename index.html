<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Diary</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;font-family:system-ui;background:#0b0d14;color:white}
#app{max-width:520px;margin:auto;padding:24px}
.logout{float:right;font-size:13px;color:#a0a5b5;cursor:pointer}
.entry{background:rgba(255,255,255,0.03);padding:14px;border-radius:16px;margin-top:12px}
</style>
</head>
<body>

<div id="app" style="display:none">
  <div class="logout" onclick="logout()">Log out</div>
  <h2>My Diary</h2>

  <textarea id="entry" style="width:100%;height:100px;margin-top:12px"></textarea>
  <button onclick="addEntry()">Save</button>

  <div id="feed"></div>
</div>

<script>
const client = supabase.createClient(
  "https://fzgmpdybtnjzqikxfaco.supabase.co",
  "sb_publishable_-uOtGJkoTs43mx32klszYQ_pOAdTkEJ"
);

async function checkSession(){
  const { data } = await client.auth.getSession();
  if(!data.session){
    location.href = "/login.html";
  } else {
    document.getElementById("app").style.display="block";
    loadEntries();
  }
}

async function loadEntries(){
  const { data } = await client.from("diary").select("content,created_at").order("created_at",{ascending:false});
  document.getElementById("feed").innerHTML = data.map(d=>`
    <div class="entry">
      <div>${d.content}</div>
      <small>${new Date(d.created_at).toLocaleString()}</small>
    </div>
  `).join("");
}

async function addEntry(){
  const text=document.getElementById("entry").value.trim();
  if(!text) return;

  const { data:userData } = await client.auth.getUser();
  await client.from("diary").insert({content:text,user_id:userData.user.id});
  document.getElementById("entry").value="";
  loadEntries();
}

async function logout(){
  await client.auth.signOut();
  location.href = "/login.html";
}

checkSession();
</script>

</body>
</html>